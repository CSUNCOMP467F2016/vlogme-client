<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/paper-styles/color.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="vlogme-landing-page.html">
<link rel="import" href="vlogme-player.html">
<link rel="import" href="vlogme-response-list.html">


<dom-module id="vlogme-app">

  <template>

    <style>

      :host {
        display: block;
        @apply(--layout-fit);
        @apply(--layout-vertical);
      }

      paper-toolbar {
        @apply(--layout-flex-none);
        background-color: var(--vlogme-color-dark, black);
      }

      paper-toolbar h1.title {
        display: inline;
        padding: 10px 0;
      }

      iron-pages {
        @apply(--layout-relative);
        height: 100%;
      }

      iron-pages>.page-item {
        @apply(--layout-horizontal);
        @apply(--layout-fit);
      }

      vlogme-landing-page {
        @apply(--layout-flex-12);
      }

      vlogme-player {
        @apply(--layout-flex-5);
      }

      vlogme-response-list {
        @apply(--layout-flex);
        @apply(--layout-self-stretch);
      }

      @media (max-width: 699px) {

        .page-item {
          @apply(--layout-vertical);
        }

        vlogme-player {
          @apply(--layout-wrap);
        }

        vlogme-response-list {
          @apply(--layout-wrap);
          @apply(--layout-flex-none);
        }

      }

    </style>

    <app-location route="{{route}}"></app-location>
    <iron-ajax id="points_ajax"
      url="http://ec2-35-164-213-202.us-west-2.compute.amazonaws.com/endpoint/response-points/1"
      method="POST"
      on-response= "fetch_response_points"></iron-ajax>
      
    <iron-ajax id="responses_ajax"
      url="http://ec2-35-164-213-202.us-west-2.compute.amazonaws.com/endpoint/video/1/[[current_point]]"
      method="POST"
      on-response= "fetch_responses"></iron-ajax>

    <paper-toolbar>
      <img style="height:90%; width:auto;" src="vlogMe_logo.JPG"></img>
    </paper-toolbar>

    <iron-pages id="pages" selected="0">
      <div class="page-item">
        <vlogme-player></vlogme-player>
        <vlogme-response-list></vlogme-response-list>
      </div>
    </iron-pages>

  </template>

  <script>
    Polymer({
      is: 'vlogme-app',

      ready: function(){
        var refresh_interval = 5000; //5 secs interval time
        var current_responses = this.$$('vlogme-response-list').get_panel();
        this.description = this.$$('vlogme-player').video_title;
        console.log("Title: " + this.$$('vlogme-player').video_title);
        //Fetch response-points from Server & copy into response_points
        this.$.points_ajax.generateRequest();
        //

        current_responses.addEventListener('iron-activate',this.play_response.bind(this));
        //Test
        var refreshing = setInterval(this.refresh_responses.bind(this), refresh_interval);
        //
      },
      properties: {
        site_title: {
          type: String,
          value: 'vlogme'
        },
        //RESPONSE_POINTS is an ordered-list of all points in Topic Video at which Comments occur
        //Each Array member variables are in seconds
        response_points:{
          type: Array,
          value: [
            12
            /*,
            42
            */
            ]
        },
        
        current_point:{ //variable for nearest Response Point
          type: Number
        }
      },

      refresh_responses: function(){
        var accuracy = 10; //range within which to display responses (before or after 'accuracy' seconds)
        var video_topic = this.$$('vlogme-player').get_player();
        var response_panel = this.$$('vlogme-response-list');
        var play_time = parseInt(video_topic.currentTime());
        var point_found = false;
        var point_check;
        var within_range = false;
        console.log("In refresh_comments function-- at "+ play_time + " secs");

        if(!video_topic.paused() && !video_topic.ended()){  //not paused and not ended
          this.response_points.forEach(function(point){
            point_check = point - play_time;
            console.log("Checking Response Point at " + point + " secs");
            console.log("Check yielded: "+ point_check.toString());
            
            //check if current point is within range
            if((-accuracy) < point_check && point_check < accuracy )
              within_range = true;
              
            //else not within range
            
            //check if video is within range of 'point' & no closer 'point' has been found
            if(!point_found && within_range){
              console.log("There are responses at "+ point + " secs");
              this.current_point = point; //Refresh Response_point for responses_ajax
              
              //TEMP --The nearest Response Point has been found, refresh 'response-list'
              response_panel.responses = []; //clear Response panel
              response_panel.push('responses',JSON.parse("{\"title\":\"Response1\",\"duration\":\"18 secs\", \"uri\":\"/comment1.mp4\"}"));
              console.log("Response 1: "+ JSON.stringify(response_panel.responses[0].title));
              response_panel.push('responses',JSON.parse("{\"title\":\"Response2\",\"duration\":\"18 secs\", \"uri\":\"/comment2.mp4\"}"));
              //

              point_found = true; //a Point was found, ignore any others
            }
            else if(point_found){ //a Response Point has been found already
              console.log("A closer Response Point has been found");
            }
            else{ //No 'point' within range
              console.log("Response point at "+ point + " secs is not within range");
              response_panel.responses = [];
            }
          });
        }
        else{
          console.log('Video Topic is not playing');
          response_panel.responses = [];
          this.current_point = '';
        }
        
        //Make response_ajax call if a valid current_point has been set
        if(current_point !== null && current_point !== '')
          this.$.responses_ajax.generateRequest();

        console.log("Exiting refresh_comments");
      },

      play_response: function(e){
        console.log('In play_response. Received parameter= ', e.detail.item.dataItem);
        var response_selected = e.detail.item.dataItem;
        var video_topic = this.$$('vlogme-player').video_uri;
        var vlogme_player = this.$$('vlogme-player');
        var video_player = this.$$('vlogme-player').get_player();
        var current_time = video_player.currentTime(); //records the time at which Video Topic was stopped
        
        //This function is fired when the Response has finished playing
        var wait_for_response_end = function(){
          //reset URI to Video_Topic
          vlogme_player.set('video_uri', video_topic);
        
          console.log('video_uri = ', vlogme_player.video_uri);
          //resume Video Topic
          //response_selected.title = response_title; //reset Response title
          video_player.currentTime(current_time);
          video_player.play();
        };
        
        //response_selected.title = 'PLAYING NOW';  //mark Response as 'Playing Now'
        //Pause Video Topic
        video_player.pause();
        
        //change video URI on videojs player
        vlogme_player.set('video_uri', response_selected.uri);
        
        //play Response video
        video_player.play();
        
        //Listen for end of Response video
        video_player.on('ended', wait_for_response_end);
      },
      
      //this function handles the Response from the AJAX request to fetch the response_points
      fetch_response_points: function(e, detail){
        console.log('--IN FETCH_RESPONSE_POINTS--');
        console.log(e);
        console.log(detail);
      },
      
      //this function handles the Response from the AJAX request to fetch the responses at a specific point
      fetch_responses: function(e, detail){
        console.log('--IN FETCH_RESPONSES--');
        console.log(e);
        console.log(detail);
      }

    });
  </script>

</dom-module>
